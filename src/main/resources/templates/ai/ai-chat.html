<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/user/head :: head}"></head>

<body>
<div th:replace="~{fragments/user/header :: header}"></div>
<div th:replace="~{fragments/user/feature :: feature}"></div>

<!-- 채팅 인터페이스 -->
<div class="chat-wrapper">
  <!-- 정보 표시 영역 -->
  <div id="info-content" class="info-box">
    <p class="info-placeholder">전통주와 어울리는 여행 일정을 추천해드립니다 🍶✈️<br>아래 입력창에 질문을 해보세요!</p>
  </div>

  <!-- 채팅 영역 -->
  <div class="chat-box">
    <div class="chat-title">AI 주락이와의 대화</div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-area">
      <input type="text" id="chat-input" placeholder="메시지를 입력하세요..." />
      <button id="chat-send-btn">보내기</button>
    </div>
  </div>
</div>

<div th:replace="~{fragments/user/footer :: footer}"></div>
<div th:replace="~{fragments/user/js :: js}"></div>
<script th:src="@{/assets/js/ai-chat/ai-chat.js}"></script>
<script th:src="@{assets/js/chatapp.js}"></script>

<!-- JS -->
<script th:inline="javascript">
  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');
  const chatMessages = document.getElementById('chat-messages');
  const infoBox = document.getElementById('info-content');

  chatSendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

  function sendMessage() {
    const text = chatInput.value.trim();
    if (!text) return;

    chatInput.disabled = true;
    chatSendBtn.disabled = true;

    const userMsg = document.createElement('div');
    userMsg.className = 'message user';
    userMsg.textContent = text;
    chatMessages.appendChild(userMsg);
    chatInput.value = '';

    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'message ai loading';
    loadingMsg.innerHTML = `
      <div class="spinner"></div>
      <span>주락이가 주류 창고를 확인하고 있습니다. </span>
      <div class="typing-bubble"><span></span><span></span><span></span></div>
    `;
    chatMessages.appendChild(loadingMsg);
    scrollToBottom(chatMessages);

    fetch('http://localhost:8080/alcohols/clova', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ ask: text })
    })
      .then(res => res.json())
      .then(data => {
        chatMessages.removeChild(loadingMsg);
        const aiText = data.result?.finalAnswer || 'AI 응답을 가져오지 못했어요.';
        typeAIMessage(aiText);
        // ⚠️ 이 시점엔 아직 입력창 활성화 안 함
        fetchClovaSchedule(aiText);  // 일정까지 다 처리하고 나서 다시 열어야 함
      })
      .catch(err => {
        chatMessages.removeChild(loadingMsg);
        typeAIMessage('오류가 발생했어요. 다시 시도해주세요.');
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        chatInput.focus();
      });
  }

  function typeAIMessage(message, delay = 15) {
    const aiMsg = document.createElement('div');
    aiMsg.className = 'message ai chat-bubble';
    chatMessages.appendChild(aiMsg);

    let index = 0;

    (function typeChar() {
      if (index < message.length) {
        aiMsg.textContent += message.charAt(index++);
        scrollToBottom(chatMessages);
        setTimeout(typeChar, delay);
      } else {
        // 링크 자동 적용 (다 타이핑하고 난 뒤에)
        aiMsg.innerHTML = linkify(aiMsg.textContent);
      }
    })();
  }

  function fetchClovaSchedule(aiText) {
    infoBox.innerHTML = `
  <p class="info-placeholder">
    여행 일정을 불러오는 중입니다
    <span class="typing-bubble">
      <span></span><span></span><span></span>
    </span>
  </p>
`;
    fetch('http://localhost:8080/alcohols/clova2', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ask: aiText })
    })
      .then(res => res.json())
      .then(data => {
        const content = data.result?.message?.content || '추천 정보를 불러오지 못했습니다.';
        typeInfoText(infoBox, content);
        // ✅ 일정 정보 다 불러오고 나서 입력창 다시 활성화
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        chatInput.focus();
      })
      .catch(err => {
        console.error('일정 요청 오류:', err);
        infoBox.innerHTML = '<p class="info-placeholder">여행 일정을 불러오는 데 실패했어요 🥲</p>';
        // 실패했어도 다시 입력 가능하게 해야겠죠
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        chatInput.focus();
      });
  }

  function typeInfoText(targetElement, text, delay = 15) {
    targetElement.innerHTML = ''; // 기존 내용 지우기

    // typed-text용 div 생성
    const typedDiv = document.createElement('div');
    typedDiv.className = 'typed-text';
    targetElement.appendChild(typedDiv);

    let index = 0;
    (function typeChar() {
      if (index < text.length) {
        // 특수문자 & 공백 보존을 위해 textContent 사용
        typedDiv.textContent += text.charAt(index++);
        typedDiv.scrollTop = typedDiv.scrollHeight; // 스크롤 따라가기
        setTimeout(typeChar, delay);
      }
    })();
  }

  function scrollToBottom(element) {
    element.scrollTop = element.scrollHeight;
  }

  // 응답 텍스트에서 URL을 자동 링크로 변환
  function linkify(text) {
    return text.replace(
      /(https?:\/\/[^\s]+)/g,
      '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
    );
  }

  window.addEventListener('DOMContentLoaded', () => {
    typeAIMessage('전통주 소믈리에 "주락이"입니다. 오늘 하루는 어땠나요? 기분이나 분위기에 어울리는 술을 추천해드릴게요 🍶', 50);
  });
</script>

<!-- CSS -->
<style>
  body {
    background-color: #f8f5f0;
    margin: 0;
    font-family: 'Nanum Myeongjo', serif;
  }

  input[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .chat-wrapper {
    display: flex;
    gap: 24px;
    padding: 40px 20px;
    justify-content: center;
    align-items: flex-start;
    min-height: 75vh;
  }

  #info-content {
    flex: 1;
    max-width: 400px;
    height: 700px;
    background: linear-gradient(135deg, #fff8f0, #f0e6d2);
    border: 2px solid #c6a664;
    border-radius: 16px;
    box-shadow: 0 6px 15px rgba(198, 166, 100, 0.3);
    display: flex;
    flex-direction: column;
    font-family: 'Nanum Myeongjo', serif;
    color: #5a4427;
    user-select: text;
  }

  #info-content::before {
    content: '🗺️ 여행 정보 제공';
    background: #a17f4b;
    color: #fff8e7;
    font-weight: 700;
    font-size: 20px;
    padding: 18px 0;
    text-align: center;
    border-radius: 16px 16px 0 0;
    user-select: none;
    letter-spacing: 1px;
    box-shadow: inset 0 -3px 5px rgba(0, 0, 0, 0.15);
  }

  .info-placeholder {
    flex: 1;
    padding: 24px 20px;
    font-style: italic;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1.5;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 0 0 16px 16px;
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.6);
    overflow-y: auto;
    color: #7a613f;
  }

  /* 타이핑되는 텍스트용 스타일 (글자 영역) */
  #info-content .typed-text {
    flex: 1;
    padding: 24px 20px;
    white-space: pre-wrap;
    line-height: 1.6;
    font-size: 1rem;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 0 0 16px 16px;
    box-shadow: inset 0 0 8px rgba(255, 255, 255, 0.7);
    overflow-y: auto;
    color: #5a4427;
    font-weight: 600;
    font-family: 'Nanum Myeongjo', serif;
    user-select: text;
    min-height: 300px;
  }

  /* 스크롤바 예쁘게 */
  #info-content::-webkit-scrollbar,
  #info-content .typed-text::-webkit-scrollbar,
  .info-placeholder::-webkit-scrollbar {
    width: 8px;
  }

  #info-content::-webkit-scrollbar-thumb,
  #info-content .typed-text::-webkit-scrollbar-thumb,
  .info-placeholder::-webkit-scrollbar-thumb {
    background-color: #bba55f;
    border-radius: 8px;
    border: 2px solid transparent;
    background-clip: content-box;
  }

  .chat-box {
    flex: 2;
    max-width: 800px;
    height: 700px;
    background: #fffdf7;
    border: 1px solid #e5dcc9;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 12px rgba(111, 78, 55, 0.15);
  }

  .chat-title {
    background: #6f4e37;
    color: white;
    padding: 18px;
    font-size: 20px;
    font-weight: bold;
    text-align: center;
    border-radius: 12px 12px 0 0;
    user-select: none;
  }

  .chat-messages {
    flex: 1;
    padding: 20px;
    background-color: #faf7f2;
    background-image: url('/assets/img/yesul/AI/bartender-ai-no-background.png');
    background-repeat: no-repeat;
    background-position: center center;
    background-size: 400px auto;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .chat-input-area {
    display: flex;
    padding: 8px;
    background-color: #f7f3eb;
    border-top: 1px solid #ddd;
    border-radius: 0 0 16px 16px;
  }

  .chat-bubble {
    user-select: text;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .chat-bubble a {
    color: #2b6cb0;
    text-decoration: underline;
  }

  #chat-input {
    flex: 1;
    padding: 14px 16px;
    border: 2px solid #a67c52;
    border-radius: 20px 0 0 20px;
    font-size: 15px;
    background-color: #fefcf7;
    outline: none;
    font-family: 'Nanum Myeongjo', serif;
  }

  #chat-send-btn {
    background: linear-gradient(to bottom, #b28b5e, #a07745);
    color: white;
    border: none;
    border-radius: 0 20px 20px 0;
    padding: 0 24px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    font-family: 'Nanum Myeongjo', serif;
  }

  #chat-send-btn:hover {
    background: linear-gradient(to bottom, #8c6c45, #7a5836);
  }

  #chat-send-btn:disabled {
    background-color: #d3c4a0;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 16px;
    line-height: 1.6;
  }

  .message.user {
    align-self: flex-end;
    background-color: #dcead7;
    color: #2e4a27;
    border: 1px solid #b6d7a8;
  }

  .message.ai {
    align-self: flex-start;
    background-color: #fff1dd;
    color: #4a3b28;
    border: 1px solid #f3d2a9;
  }

  .message.ai.loading {
    font-style: italic;
    color: #888;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .typing-bubble {
    display: inline-flex; /* 또는 inline-block */
    gap: 6px;
    align-items: center;
    justify-content: center;
  }

  .typing-bubble span {
    width: 8px;
    height: 8px;
    background-color: #b9996d;
    border-radius: 50%;
    animation: bounce 1.3s infinite;
    opacity: 0.5;
  }

  .typing-bubble span:nth-child(2) { animation-delay: 0.2s; }
  .typing-bubble span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); opacity: 0.5; }
    40% { transform: translateY(-6px); opacity: 1; }
  }

  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #ccc;
    border-top-color: #b28b5e;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
</body>
</html>