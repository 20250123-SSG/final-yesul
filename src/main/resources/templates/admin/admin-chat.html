<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/head :: head">
  <title>Admin Chat</title>
</head>

<body>
<!-- ✅ Admin Header Fragment -->
<header th:replace="admin/header :: header"></header>

<main class="admin-chat-container">
  <div class="chat-wrapper">

    <!-- ✅ 왼쪽: 채팅방 리스트 + 검색 -->
    <aside class="chat-sidebar">
      <div class="chat-search">
        <input type="text" id="chatSearchInput" placeholder="사용자 검색" />
        <button id="chatSearchBtn">검색</button>
      </div>

      <ul id="chatRoomList">
        <li th:each="room : ${chatRooms}">
          <a href="#" th:data-room-id="${room.roomId}" class="chat-room-item">
            <div class="room-name" th:text="${room.userName}">사용자 이름</div>
            <div class="room-last-message" th:text="${room.lastMessage}">최근 메시지</div>
            <div class="room-unread" th:text="${room.unreadCount}">0</div>
          </a>
        </li>
      </ul>

      <!-- 무한스크롤 로딩 스피너 -->
      <div id="chatRoomLoading" style="display:none;">Loading...</div>
    </aside>

    <!-- ✅ 오른쪽: 선택된 채팅방 상세 -->
    <section class="chat-main">
      <div class="chat-header">
        <h3 id="selectedUserName">선택된 사용자</h3>
      </div>

      <div id="chatMessages" class="chat-messages">
        <!-- 메시지 내역 -->
      </div>

      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="메시지를 입력하세요" />
        <button id="sendMessageBtn">전송</button>
      </div>
    </section>

  </div>
</main>

<!-- ✅ Admin Footer Fragment -->
<footer th:replace="admin/footer :: footer"></footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // 채팅방 클릭
  $(document).on('click', '.chat-room-item', function() {
    const roomId = $(this).data('room-id');
    loadChatRoomDetail(roomId);
  });

  function loadChatRoomDetail(roomId) {
    $('#selectedUserName').text('로딩중...');
    $('#chatMessages').html('<div>Loading...</div>');

    // 예시: AJAX로 메시지 가져오기
    $.get('/admin/chatroom/' + roomId + '/messages', function(data) {
      $('#selectedUserName').text(data.userName);
      $('#chatMessages').html(data.messagesHtml);
    });
  }

  // 검색
  $('#chatSearchBtn').on('click', function() {
    const keyword = $('#chatSearchInput').val();
    window.location.href = '/admin/chatroom?keyword=' + keyword;
  });

  // 무한스크롤
  let loading = false;
  $(window).scroll(function() {
    if (loading) return;

    if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
      loading = true;
      $('#chatRoomLoading').show();

      // TODO: cursor 파라미터 붙여서 AJAX 호출!
      // 예: $.get('/admin/chatroom?cursor=...', appendNewRooms);
    }
  });

  // 메시지 전송 버튼
  $('#sendMessageBtn').on('click', function() {
    const content = $('#messageInput').val();
    if (!content) return;

    // TODO: WebSocket send 로직
    console.log('전송:', content);
    $('#messageInput').val('');
  });
</script>

<style>
  .admin-chat-container {
    display: flex;
    height: 90vh;
  }
  .chat-wrapper {
    display: flex;
    flex: 1;
  }
  .chat-sidebar {
    width: 300px;
    border-right: 1px solid #ccc;
    overflow-y: auto;
    padding: 10px;
  }
  .chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .chat-header {
    border-bottom: 1px solid #ccc;
    padding: 10px;
  }
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }
  .chat-input {
    display: flex;
    border-top: 1px solid #ccc;
    padding: 10px;
  }
  .chat-input input {
    flex: 1;
    margin-right: 10px;
  }
</style>

</body>
</html>
