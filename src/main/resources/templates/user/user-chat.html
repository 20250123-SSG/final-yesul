<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{fragments/admin/head :: adminHead}">
  <meta charset="UTF-8" />
  <title>User Chat</title>

  <!-- Vendor CSS -->
  <link rel="stylesheet" href="/assets/css/vendor/bootstrap.min.css">
  <link rel="stylesheet" href="/assets/css/vendor/remixicon.css">

  <style>
    /* (기존 스타일 블록 전부 동일) */
    body {
      background: #f8f9fa;
      font-family: Arial, sans-serif;
    }
    #chat-message-list {
      height: 500px;
      overflow-y: auto;
      padding: 20px;
      background: #fff;
      border: none;
    }
    #messageList {
      padding: 0;
      margin: 0;
      list-style: none;
    }
    .message-row {
      display: flex;
      margin: 8px 0;
      max-width: 100%;
    }
    .my-message { justify-content: flex-end; }
    .other-message { justify-content: flex-start; }
    .bubble {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 60%;
      word-wrap: break-word;
      font-size: 15px;
      line-height: 1.4;
    }
    .my-message .bubble {
      background: #007bff;
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .other-message .bubble {
      background: #f1f0f0;
      color: #000;
      border-bottom-left-radius: 4px;
    }
    .message-input {
      padding: 15px;
      background: #fff;
      border-top: 1px solid #ddd;
    }
    .wrap-send {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .wrap-send input[type="text"] {
      flex: 1;
      border: none;
      border-radius: 20px;
      padding: 12px 20px;
      background: #f0f0f0;
      font-size: 15px;
    }
    .wrap-send input[type="text"]:focus {
      outline: none;
    }
    .wrap-send .send-btn {
      border: none;
      background: #007bff;
      color: #fff;
      padding: 10px 12px;
      border-radius: 50%;
      cursor: pointer;
    }
    .wrap-send .send-btn i {
      font-size: 18px;
    }

    /* ===== 강제 오버라이드: 말풍선 무조건 보이게 ===== */
    #messageList .bubble {
      display: inline-block !important;
      background-color: #f1f0f0 !important;
      color: #000 !important;
      padding: 12px 16px !important;
      border-radius: 18px !important;
      max-width: 60% !important;
      word-wrap: break-word !important;
      font-size: 15px !important;
      line-height: 1.4 !important;
    }
    #messageList .my-message .bubble {
      background-color: #007bff !important;
      color: #fff      !important;
    }
    #messageList .other-message .bubble {
      background-color: #f1f0f0 !important;
      color: #000       !important;
    }
    /* ============================================= */
  </style>
</head>

<body>
<main class="wrapper sb-default ecom">

  <!-- 공통 레이아웃 -->
  <div th:replace="~{fragments/admin/header :: adminHeader}"></div>
  <div th:replace="~{fragments/admin/sidebar :: adminSidebar}"></div>
  <div th:replace="~{fragments/admin/notify-sidebar :: adminNotifySidebar}"></div>

  <!-- 채팅방 컨텐츠 -->
  <div class="gi-main-content">
    <div class="container-fluid">
      <div class="gi-chatapp">
        <div class="gi-card chatapp-card">
          <div id="fx_chat">
            <div class="content">

              <!-- 상대방 프로필 -->
              <div class="contact-profile">
                <div class="user-detail">
                  <img src="/assets/img/user/2.jpg" alt="user">
                  <div class="name">
                    <p th:text="${chatPartnerName}">채팅 상대 이름</p>
                    <span class="online">Online</span>
                  </div>
                </div>
              </div>

              <!-- 메시지 리스트 -->
              <div class="messages" id="chat-message-list">
                <ul id="messageList">
                  <li class="message-row"
                      th:each="msg : ${messages}"
                      th:classappend="${msg.senderType.name()} == 'USER' ? ' my-message' : ' other-message'">
                    <div class="bubble" th:text="${msg.messageContext}">
                      메시지 내용
                    </div>
                  </li>
                </ul>
              </div>

              <!-- 입력창 -->
              <div class="message-input">
                <div class="wrap-send">
                  <input id="messageInput" type="text" placeholder="메시지를 입력하세요">
                  <button type="button" onclick="sendMessage()" class="submit send-btn">
                    <i class="ri-send-plane-line"></i>
                  </button>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer / Scripts -->
  <div th:replace="~{fragments/admin/footer :: adminFooter}"></div>
  <div th:replace="~{fragments/admin/script :: adminScripts}"></div>

  <!-- Hidden Field -->
  <input type="hidden" id="chatRoomId" th:value="${roomId}">

  <!-- WebSocket + JS -->
  <script th:inline="javascript">
    const socket       = new WebSocket("ws://" + window.location.host + "/ws/chat");
    const messageInput = document.getElementById("messageInput");
    const chatRoomId   = document.getElementById("chatRoomId").value;
    const chatList     = document.getElementById("chat-message-list");

    socket.onopen = () => console.log("✅ WebSocket 연결 성공!");

    socket.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      appendMessage(msg.messageContext, msg.senderType);
      scrollToBottom();
    };

    function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;
      socket.send(JSON.stringify({
        chatRoomId,
        senderType: "USER",
        messageContext: message,
        messageType: "TEXT"
      }));
      messageInput.value = "";
    }

    window.addEventListener("keyup", e => {
      if (e.key === "Enter" && !e.shiftKey && document.activeElement === messageInput) {
        e.preventDefault();
        sendMessage();
      }
    });

    function appendMessage(content, senderType) {
      const li = document.createElement("li");
      li.className = 'message-row ' + ((senderType||'').toUpperCase()==='USER' ? 'my-message' : 'other-message');
      const bubble = document.createElement("div");
      bubble.className = 'bubble';
      bubble.textContent = content;
      li.appendChild(bubble);
      document.getElementById("messageList").appendChild(li);
    }

    function scrollToBottom() {
      chatList.scrollTop = chatList.scrollHeight;
    }
  </script>
</main>
</body>
</html>
